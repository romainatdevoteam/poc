name: "Terraform Infrastructure Deploy"

on:
  push:
    branches:
      - main

# Permissions minimales requises pour le GITHUB_TOKEN
permissions:
  contents: read

jobs:
  terraform:
    name: "Terraform Plan & Apply"
    runs-on: ubuntu-latest
    
    # IMPORTANT: Doit correspondre au nom de l'environnement créé dans GitHub
    # C'est ce qui permet d'accéder aux 'Environment secrets' et 'variables' de ta capture.
    environment: poc 

    # Injection des variables d'auth pour que Terraform (provider azurerm) les détecte automatiquement
    env:
      ARM_CLIENT_ID: ${{ vars.APP_ID }}             # Mappé sur ton 'APP_ID'
      ARM_CLIENT_SECRET: ${{ secrets.SC_PASSWORD }} # Mappé sur ton secret 'SC_PASSWORD'
      ARM_SUBSCRIPTION_ID: ${{ vars.SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ vars.TENANT_ID }}
      # Note: SC_ID (Service Principal Object ID) est rarement requis pour l'auth pure, 
      # mais disponible via ${{ vars.SC_ID }} si nécessaire.

    steps:
      - name: "Checkout Code"
        uses: actions/checkout@v4

      - name: "Setup Terraform"
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: "Terraform Init"
        id: init
        # L'authentification se fait automatiquement via les variables d'env ARM_* globales.
        # La configuration (noms des ressources) est injectée ici via les drapeaux CLI.
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ vars.BACKEND_RG }}" \
            -backend-config="storage_account_name=${{ vars.BACKEND_SA_NAME }}" \
            -backend-config="container_name=${{ vars.BACKEND_CONTAINER_NAME }}" \
            -backend-config="key=prod.terraform.tfstate"

      - name: "Terraform Validate"
        id: validate
        run: terraform validate

      - name: "Terraform Plan"
        id: plan
        run: terraform plan -out=tfplan

      - name: "Terraform Apply"
        id: apply
        # Auto-approve car on est sur la branche main (CD continu)
        run: terraform apply -auto-approve tfplan